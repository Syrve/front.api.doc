---
title: Returning an order (cancellation)
layout: default
---

Now it is possible to return orders not only from [UI Syrve POS](https://en.syrve.help/articles/#!syrve-pos-8-6/canceling-orders),
but also from the V8Preview7 API. To do this you need to call the method [`StornoOrder`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_StornoOrder.htm).

Thus, we have closed the payment loop from the API, in which a full set of actions is now available:

- Making an advance payment: [`ProcessPrepay`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_ProcessPrepay.htm)
- Refund of prepayment / completed payment: [`UnprocessPayment`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_UnprocessPayment.htm)
- Payment for the order: [`PayOrder`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_PayOrder.htm), [`PayOrderAndPayOutOnUser`](https://iiko.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_PayOrderAndPayOutOnUser.htm)
- Order refund/cancellation: [`StornoOrder`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IOperationService_StornoOrder.htm)

To return an order, the plugin must support payment transactions.
The employee whose
[`ICredentials`](https://syrve.github.io/front.api.sdk/v8/html/T_Resto_Front_Api_Data_Security_ICredentials.htm)
we transfer to the order reversal method must have the F_STRN (Make a refund) right.
The cash register shift in which the order was paid must be open and belong to the current terminal, because reversal is done locally.
There should be enough cash in the cash register if the order was paid in cash.
All payments subject to refund must support quiet payment.

Details about unsuccessful reversal, which may result in discarding [`PaymentActionFailedException`](https://syrve.github.io/front.api.sdk/v8/html/T_Resto_Front_Api_Exceptions_PaymentActionFailedException.htm),
were merged with [details about unsuccessful payment]({{ site.baseurl }}/2023/08/28/more-info-about-pay-fail.html),
accordingly, the field [`PaymentActionFailedException.Reason`](https://syrve.github.io/front.api.sdk/v8/html/P_Resto_Front_Api_Exceptions_PaymentActionFailedException_Reason.htm)
is now filled in in the method `StornoOrder`.
List [`PaymentActionFailedExceptionReason`](https://syrve.github.io/front.api.sdk/v8/html/T_Resto_Front_Api_Exceptions_PaymentActionFailedExceptionReason.htm)
has been expanded with new items:

- `SomeOfCafeSessionsIsClosed`,
- `StornoOrderFailed`,
- `StornoNotSupported`,
- `OrderStatusIsNotClosed`,
- `OrderCloseAndStornoOnDifferentTerminalNotSupported`,
- `DeliveryOrderStatusIsCanceled`

From which

- `PaymentsProcessingCanceled`,
- `PaymentsProcessingFailed`,
- `BeforeDoChequeOperationFailed`,
- `ChequeTaskProcessorFailed`,
- `CashRegisterOperationFailed`

have the specified property [`PaymentActionFailedException.Details`](https://syrve.github.io/front.api.sdk/v8/html/P_Resto_Front_Api_Exceptions_PaymentActionFailedException_Details.htm),
which will contain an exception message generated by another plugin in

- [`IPaymentProcessor.ReturnPaymentSilently`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_IPaymentProcessor_ReturnPaymentSilently.htm),
- [`INotificationService.BeforeDoCheque`](https://syrve.github.io/front.api.sdk/v8/html/P_Resto_Front_Api_INotificationService_BeforeDoCheque.htm),
- [`IChequeTaskProcessor.BeforeDoCheckAction`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_Devices_IChequeTaskProcessor_BeforeDoCheckAction.htm),
- [`ICashRegister.DoCheque`](https://syrve.github.io/front.api.sdk/v8/html/M_Resto_Front_Api_Devices_ICashRegister_DoCheque.htm).

Reason for failed reversal ([`PaymentActionFailedException.Reason`](https://iiko.github.io/front.api.sdk/v8/html/P_Resto_Front_Api_Exceptions_PaymentActionFailedException_Reason.htm))
`CashForChangeNotEnough` was renamed to `CashNotEnough`.

I would also like to note that it is now possible to delete a paid order. An example call diagram for a closed order would look like this:

```
var order = PluginContext.Operations.GetOrders().Last(o => o.Status == OrderStatus.Closed);
var credentials = PluginContext.Operations.AuthenticateByPin("777");

// We cancel the order and return the payment
order = PluginContext.Operations.StornoOrder(order, credentials);

// We refund prepayments if they were included in the order
foreach (var orderPayment in order.Payments)
{
    PluginContext.Operations.UnprocessPayment(order, orderPayment, credentials);
    order = PluginContext.Operations.GetOrderById(order.Id);
}

// Deleting printed order items
if (order.Items.Count > 0)
{
    PluginContext.Operations.DeletePrintedOrderItems(
        "reason",
        WriteoffOptions.WriteoffToCafe(PluginContext.Operations.GetActiveRemovalTypes().First(rt => rt.WriteoffType.HasFlag(WriteoffType.Cafe))),
        order,
        order.Items,
        credentials);
    order = PluginContext.Operations.GetOrderById(order.Id);
}

// Deleting an order
PluginContext.Operations.DeleteOrder(order, credentials);
```